<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Eventos en vivo</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap');
    :root {
      --bg: #0c0f1a;
      --panel: #131a2b;
      --border: #1f2941;
      --accent: #58d6a6;
      --muted: #94a3b8;
      --event: #7ad3ff;
      --danger: #f472b6;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 24px;
      background: radial-gradient(circle at 20% 20%, rgba(88,214,166,0.12), transparent 35%), radial-gradient(circle at 80% 0%, rgba(122,211,255,0.12), transparent 30%), var(--bg);
      color: #e2e8f0;
      font-family: 'Space Grotesk', 'Inter', system-ui, -apple-system, sans-serif;
    }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    h1 { margin: 0; font-size: 24px; letter-spacing: 0.5px; }
    .status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--muted);
      font-weight: 600;
      font-size: 14px;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--muted);
      box-shadow: 0 0 0 4px rgba(88,214,166,0.08);
    }
    .status.connected { color: var(--accent); }
    .status.connected .dot { background: var(--accent); }
    .status.error { color: var(--danger); }
    .status.error .dot { background: var(--danger); box-shadow: 0 0 0 4px rgba(244,114,182,0.12); }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.35);
    }
    .list {
      display: grid;
      gap: 12px;
      margin: 0;
      padding: 0;
      list-style: none;
      max-height: 70vh;
      overflow-y: auto;
    }
    .item {
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(19,26,43,0.7);
      display: grid;
      gap: 6px;
    }
    .meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--muted);
    }
    .event-name {
      color: var(--event);
      font-weight: 600;
      letter-spacing: 0.3px;
    }
    pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: 'SFMono-Regular', Consolas, 'Courier New', monospace;
      color: #cbd5e1;
      background: rgba(15,23,42,0.35);
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 13px;
    }
    input {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(19,26,43,0.7);
      color: #e2e8f0;
    }
    button {
      padding: 12px 14px;
      border: none;
      border-radius: 10px;
      background: var(--accent);
      color: #0b1426;
      font-weight: 700;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <h1>Eventos de catálogo</h1>
    <div id="status" class="status"><span class="dot"></span><span class="label">Sin conexión</span></div>
  </header>

  <div class="panel" style="margin-bottom:16px; display:grid; gap:12px;">
    <form id="login-form" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px; align-items:end;">
      <div style="display:grid; gap:6px;">
        <label for="email" style="color:#cbd5e1; font-size:13px;">Email</label>
        <input id="email" type="email" required placeholder="usuario@example.com">
      </div>
      <div style="display:grid; gap:6px;">
        <label for="password" style="color:#cbd5e1; font-size:13px;">Contraseña</label>
        <input id="password" type="password" required placeholder="••••••••">
      </div>
      <button type="submit">Iniciar sesión</button>
      <div id="login-status" style="color:#f472b6; font-size:13px;"></div>
    </form>
  </div>

  <div class="panel">
    <ul id="log" class="list"></ul>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const statusLabel = statusEl.querySelector('.label');
    const log = document.getElementById('log');
    const loginForm = document.getElementById('login-form');
    const loginStatus = document.getElementById('login-status');

    let socket = null;
    let token = '';

    function setStatus(state, message) {
      statusEl.classList.remove('connected', 'error');
      if (state) {
        statusEl.classList.add(state);
      }
      statusLabel.textContent = message;
    }

    function append(eventName, payload) {
      const item = document.createElement('li');
      item.className = 'item';
      const time = new Date().toLocaleTimeString();
      const pretty = typeof payload === 'string' ? payload : JSON.stringify(payload, null, 2);
      item.innerHTML = `
        <div class="meta">
          <span class="event-name">${eventName}</span>
          <span>${time}</span>
        </div>
        <pre>${pretty}</pre>
      `;
      log.prepend(item);
      while (log.children.length > 100) {
        log.removeChild(log.lastChild);
      }
    }

    function connect() {
      if (!token) {
        setStatus('error', 'Falta token; inicia sesión primero');
        return;
      }
      if (socket) {
        socket.close();
      }

      const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
      const wsUrl = `${protocol}://${window.location.host}/ws?token=${encodeURIComponent(token)}`;
      socket = new WebSocket(wsUrl);

      socket.addEventListener('open', () => setStatus('connected', 'Conectado'));
      socket.addEventListener('close', () => setStatus('error', 'Desconectado'));
      socket.addEventListener('error', () => setStatus('error', 'Error de conexión'));
      socket.addEventListener('message', (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data && data.event !== undefined) {
            append(data.event, data.data ?? {});
          } else {
            append('mensaje', data);
          }
        } catch (err) {
          append('raw', event.data);
        }
      });
    }

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginStatus.textContent = '';
      setStatus(null, 'Conectando...');
      try {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const resp = await fetch('/api/v1/identity/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        if (!resp.ok) {
          const data = await resp.json().catch(() => ({}));
          throw new Error(data.error || 'Login falló');
        }
        const data = await resp.json();
        token = data.token;
        loginStatus.style.color = '#58d6a6';
        loginStatus.textContent = 'Login exitoso';
        connect();
      } catch (err) {
        loginStatus.style.color = '#f472b6';
        loginStatus.textContent = err.message;
        setStatus('error', 'Login requerido');
      }
    });
  </script>
</body>
</html>
